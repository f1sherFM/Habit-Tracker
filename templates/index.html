{% extends "base.html" %}

{% block title %}Dashboard - Habit Tracker{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages" class="mb-6 space-y-3">
            {% for category, message in messages %}
                {% if category == 'error' %}
                    <div class="flash-message bg-red-500/20 border border-red-500/30 text-red-200 px-4 py-3 rounded-xl backdrop-blur-sm transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span>{{ message }}</span>
                            </div>
                            <button onclick="closeFlashMessage(this)" class="ml-4 text-red-300 hover:text-red-100 transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                {% elif category == 'success' %}
                    <div class="flash-message bg-green-500/20 border border-green-500/30 text-green-200 px-4 py-3 rounded-xl backdrop-blur-sm transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>{{ message }}</span>
                            </div>
                            <button onclick="closeFlashMessage(this)" class="ml-4 text-green-300 hover:text-green-100 transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                {% else %}
                    <div class="flash-message bg-blue-500/20 border border-blue-500/30 text-blue-200 px-4 py-3 rounded-xl backdrop-blur-sm transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span>{{ message }}</span>
                            </div>
                            <button onclick="closeFlashMessage(this)" class="ml-4 text-blue-300 hover:text-blue-100 transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            
            <!-- Close All Button (показывается только если есть несколько уведомлений) -->
            {% if messages|length > 1 %}
                <div class="text-center">
                    <button onclick="closeAllFlashMessages()" class="text-slate-400 hover:text-slate-200 text-sm transition-colors duration-200">
                        <i class="fas fa-times-circle mr-1"></i>
                        Close All Notifications
                    </button>
                </div>
            {% endif %}
        </div>
    {% endif %}
{% endwith %}

<!-- Header Section -->
<div class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h2 class="text-3xl font-bold text-slate-100 mb-2">Your Habits</h2>
            <p class="text-slate-400">Track your daily progress and build lasting habits</p>
        </div>
        
        <!-- Add Habit Button -->
        <button onclick="openAddHabitModal()" class="btn-primary mt-4 sm:mt-0 px-6 py-3 rounded-lg text-white font-medium flex items-center space-x-2">
            <i class="fas fa-plus"></i>
            <span>Add Habit</span>
        </button>
    </div>
</div>

<!-- Habits Grid -->
{% if habits %}
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% for habit in habits %}
            <div class="habit-card glass-card rounded-xl p-6">
                <!-- Habit Header -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-100 mb-1">{{ habit.name }}</h3>
                        {% if habit.description %}
                            <p class="text-sm text-slate-400">{{ habit.description }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Delete Button -->
                    <form action="{{ url_for('delete_habit', habit_id=habit.id) }}" method="POST" class="ml-4" onsubmit="return confirm('Are you sure you want to delete this habit?');">
                        <button type="submit" class="text-slate-500 hover:text-red-400 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-slate-400">7-Day Progress</span>
                        <span class="text-sm font-medium text-slate-300">{{ habit.get_completion_rate() }}%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2">
                        <div class="progress-bar h-2 rounded-full transition-all duration-300" style="width: {{ habit.get_completion_rate() }}%"></div>
                    </div>
                </div>
                
                <!-- Last 7 Days -->
                <div>
                    <p class="text-sm text-slate-400 mb-3">Last 7 Days</p>
                    <div class="flex justify-between items-center space-x-1">
                        {% for day in habit.get_last_7_days() %}
                            <div class="flex flex-col items-center space-y-1">
                                <button 
                                    class="habit-day w-10 h-10 rounded-full border-2 flex items-center justify-center
                                        {% if day.completed %}
                                            completed border-green-500
                                        {% else %}
                                            border-slate-600 hover:border-slate-500
                                        {% endif %}"
                                    onclick="toggleHabit({{ habit.id }}, '{{ day.date }}')"
                                    title="{{ day.date_str }} - {{ 'Completed' if day.completed else 'Not completed' }}">
                                    {% if day.completed %}
                                        <i class="fas fa-check text-white text-sm"></i>
                                    {% else %}
                                        <span class="text-xs text-slate-500">{{ loop.index }}</span>
                                    {% endif %}
                                </button>
                                <span class="text-xs text-slate-500">{{ day.date_str[:3] }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <!-- Empty State -->
    <div class="glass-card rounded-xl p-12 text-center">
        <div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-clipboard-list text-slate-400 text-2xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-slate-100 mb-2">No habits yet</h3>
        <p class="text-slate-400 mb-6">Start building better habits by adding your first one!</p>
        <button onclick="openAddHabitModal()" class="btn-primary px-6 py-3 rounded-lg text-white font-medium">
            Add Your First Habit
        </button>
    </div>
{% endif %}

<!-- Add Habit Modal -->
<div id="addHabitModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="glass-card rounded-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-slate-100">Add New Habit</h3>
                <button onclick="closeAddHabitModal()" class="text-slate-500 hover:text-slate-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form action="{{ url_for('add_habit') }}" method="POST">
                <div class="mb-4">
                    <label for="habitName" class="block text-sm font-medium text-slate-300 mb-2">
                        Habit Name <span class="text-red-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="habitName" 
                        name="name" 
                        required
                        maxlength="100"
                        class="form-input w-full px-4 py-3 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none"
                        placeholder="e.g., Drink 8 glasses of water">
                </div>
                
                <div class="mb-6">
                    <label for="habitDescription" class="block text-sm font-medium text-slate-300 mb-2">
                        Description (optional)
                    </label>
                    <textarea 
                        id="habitDescription" 
                        name="description" 
                        rows="3"
                        class="form-input w-full px-4 py-3 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none resize-none"
                        placeholder="Add more details about your habit..."></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="closeAddHabitModal()" class="flex-1 px-4 py-3 border border-slate-600 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary flex-1 px-4 py-3 rounded-lg text-white font-medium">
                        Add Habit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal Functions
function openAddHabitModal() {
    document.getElementById('addHabitModal').classList.remove('hidden');
    document.getElementById('habitName').focus();
    document.body.style.overflow = 'hidden';
}

function closeAddHabitModal() {
    document.getElementById('addHabitModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    // Reset form
    document.querySelector('#addHabitModal form').reset();
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAddHabitModal();
    }
});

// Close modal on backdrop click
document.getElementById('addHabitModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddHabitModal();
    }
});

// Toggle Habit Completion
async function toggleHabit(habitId, date) {
    const button = event.target.closest('.habit-day');
    const originalContent = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin text-white text-sm"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch(`/toggle-habit/${habitId}/${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload the page to update the UI
            location.reload();
        } else {
            throw new Error(data.error || 'Failed to toggle habit');
        }
    } catch (error) {
        console.error('Error:', error);
        // Restore original content
        button.innerHTML = originalContent;
        button.disabled = false;
        
        // Show error message
        alert('Failed to update habit. Please try again.');
    }
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('#addHabitModal form');
    const nameInput = document.getElementById('habitName');
    
    form.addEventListener('submit', function(e) {
        if (nameInput.value.trim().length === 0) {
            e.preventDefault();
            nameInput.focus();
            return false;
        }
    });
    
    // Character counter for habit name
    nameInput.addEventListener('input', function() {
        const remaining = 100 - this.value.length;
        if (remaining < 10) {
            this.style.borderColor = remaining < 0 ? '#ef4444' : '#f59e0b';
        } else {
            this.style.borderColor = '';
        }
    });
});

// Flash Message Functions
function closeFlashMessage(button) {
    const message = button.closest('.flash-message');
    message.style.opacity = '0';
    message.style.transform = 'translateX(100%)';
    
    setTimeout(() => {
        message.remove();
        
        // Check if there are any messages left
        const flashContainer = document.getElementById('flash-messages');
        const remainingMessages = flashContainer.querySelectorAll('.flash-message');
        
        if (remainingMessages.length === 0) {
            flashContainer.remove();
        }
    }, 300);
}

function closeAllFlashMessages() {
    const flashContainer = document.getElementById('flash-messages');
    const messages = flashContainer.querySelectorAll('.flash-message');
    
    messages.forEach((message, index) => {
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transform = 'translateX(100%)';
        }, index * 100);
    });
    
    setTimeout(() => {
        flashContainer.remove();
    }, messages.length * 100 + 300);
}

// Auto-hide success messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const successMessages = document.querySelectorAll('.flash-message:has(.fa-check-circle)');
    
    successMessages.forEach(message => {
        setTimeout(() => {
            const closeButton = message.querySelector('button');
            if (closeButton && message.parentNode) {
                closeFlashMessage(closeButton);
            }
        }, 5000);
    });
});
</script>
{% endblock %}